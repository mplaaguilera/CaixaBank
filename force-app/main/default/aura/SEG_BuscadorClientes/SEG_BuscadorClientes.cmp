<aura:component controller="SEG_BuscadorClientes" implements="flexipage:availableForRecordHome,force:hasRecordId,force:hasSObjectName">

    <!-- Atributos generales -->
    <aura:attribute name="tipoBuscador" type="String" default="registroVinculado" />
    <aura:attribute name="alfBackground" type="String" default="" />
    <!-- Binding variables -->
    <aura:attribute name="searchAccountId" type="String" default="" />
    <aura:attribute name="searchContactId" type="String" default="" />
    <aura:attribute name="searchAccountName" type="String" default="" />
    <aura:attribute name="searchContactName" type="String" default="" />
    <aura:attribute name="cuentaData" type="Account" />
    <aura:attribute name="contactoData" type="Contact" />
    <aura:attribute name="errorLDS" type="String" default="" />

    <!-- Atributos del componente -->
    <aura:attribute name="sObjectName" type="String" default="Case" />
    <aura:attribute name="recordId" type="String" />
    <aura:attribute name="sBusqueda" type="String" default="" />
    <aura:attribute name="oContactos" type="List" />
    <aura:attribute name="oCuentas" type="List" />
    <aura:attribute name="identificacionPrevia" type="Boolean" default="true" />
    <aura:attribute name="bError" type="Boolean" default="false" />
    <aura:attribute name="sMensErr" type="String" />
    <aura:attribute name="bEsperaSFDC" type="Boolean" default="false" />
    <aura:attribute name="bInfo" type="Boolean" default="false" />
    <aura:attribute name="sMensInfo" type="String" />

    <!-- Parámetros Segmentos -->
    <aura:attribute name="tipoCaso" type="String" default="SIN_REGISTRO" />
    <aura:attribute name="estadoCaso" type="String" />
    <!--<aura:attribute name="searchOptionsContact" type="List" default="[{'label': 'Nombre', 'value': 'Nombre'}, {'label': 'Email', 'value': 'Mail'}, {'label': 'Cargo', 'value': 'Cargo'}]"/>-->
    <aura:attribute name="searchOptionsContact" type="List" default="[{'label': 'Cargo', 'value': 'Cargo'}, {'label': 'Nombre', 'value': 'Nombre'}, {'label': 'Email', 'value': 'Email'}, {'label': 'Apellido', 'value': 'Apellido'}]" />
    <aura:attribute name="searchTypeContact" type="String" default="" />
    <aura:attribute name="valueSearch" type="String" default="" />
    <aura:attribute name="cuentaSel" type="String" default="" />
    <aura:attribute name="pagina" type="Integer" default="1" />
    <aura:attribute name="totalPaginas" type="Integer" default="1" />
    <aura:attribute name="searchResult" type="Map" />
    <aura:attribute name="mostrarResultados" type="Boolean" default="false" />
    <aura:attribute name="divResultadosStyle" type="String" default="width: 76%; margin: 0 auto;" />

    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />

    <lightning:workspaceAPI aura:id="workspace" />
    <aura:handler event="force:refreshView" action="{!c.doInit}" />

    <!-- Actualización datos del caso -->
    <aura:if isTrue="{!v.tipoBuscador == 'registroVinculado'}">
        <force:recordData aura:id="recordLoader" recordId="{!v.recordId}" layoutType="COMPACT" fields="AccountId, ContactId, CC_No_Identificado__c" recordUpdated="{!c.recordUpdated}" />
    </aura:if>

    <!-- Obtención de datos buscados -->
    <aura:if isTrue="{!v.searchAccountId != ''}">
        <force:recordData aura:id="accountData" recordId="{!v.searchAccountId}" layoutType="COMPACT" fields="Name" targetFields="{!v.cuentaData}" targetError="{!v.errorLDS}" recordUpdated="{!c.recordDataAccountUpdated}" />
    </aura:if>
    <aura:if isTrue="{!v.searchContactId != ''}">
        <force:recordData aura:id="contactData" recordId="{!v.searchContactId}" layoutType="COMPACT" fields="Name" targetFields="{!v.contactoData}" targetError="{!v.errorLDS}" recordUpdated="{!c.recordDataContactUpdated}" />
    </aura:if>

    <!--UI-->
    <!--Card-->
    <article class="slds-card" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">

        <!--Spinners-->
        <aura:if isTrue="{!v.bEsperaSFDC}">
            <div class="spinnerSFDC">
                <lightning:spinner variant="brand" alternativeText="Actualizando csao..." />
            </div>
        </aura:if>

        <!--Cabecera de la card-->
        <aura:if isTrue="{!v.tipoBuscador == 'registroVinculado'}">
            <div class="slds-card__header slds-grid">
                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                    <div class="slds-media__figure">
                        <lightning:icon iconName="custom:custom64" size="small" class="cc_azul_cuenta" />
                    </div>
                    <div class="slds-media__body">
                        <h2 class="slds-card__header-title">
                            <span class="slds-card__header-link slds-truncate" style="font-size: 16px;">Identificar Cliente</span>
                        </h2>
                    </div>
                </header>
            </div>
        </aura:if>

        <!--Cuerpo de la card-->
        <div class="slds-card__body slds-card__body_inner" style="position: relative;">
            <div class="slds-grid slds-gutters_direct slds-gutters_direct-x-small slds-grid_vertical-align-end">
                <div class="slds-col">
                    <span onkeypress="{!c.lanzarBusqueda}">
                        <lightning:input
                            aura:id="valorBusqueda"
                            type="search"
                            label=""
                            value="{!v.sBusqueda}"
                            onchange="{!c.cambioValorBusqueda}"
                            spellcheck="false"
                            variant="label-hidden"
                            placeholder="Buscar clientes..."
                            style="background-color: white;"
                            disabled="{!v.estadoCaso == 'Cerrado'}"
                        />
                    </span>
                </div>
                <!--Botón para iniciar búsqueda-->
                <div class="slds-col slds-grow-none">
                    <lightning:button label="Buscar" variant="brand" iconName="utility:search" onclick="{!c.iniciarBusqueda}" disabled="{!or(v.sBusqueda == '', v.estadoCaso == 'Cerrado')}" />
                </div>
                <!--Botón "No se identifica"-->
                <aura:if isTrue="{!v.tipoBuscador == 'registroVinculado'}">
                    <div class="slds-col slds-grow-none slds-shrink-none">
                        <lightning:button label="No se identifica" onclick="{!c.handleActualizarIdentificacion}" disabled="{! v.identificacionPrevia}" />
                    </div>
                </aura:if>
            </div>
        </div>
        <div style="height:0.4rem;" />
        <!--Separador-->

        <aura:if isTrue="{!or(v.searchAccountId != '', v.searchContactId != '')}">
            <div>
                <p class="slds-form-element__label">Datos seleccionados:</p>
                <aura:if isTrue="{!v.searchAccountId != ''}">
                    <div align="left" class="slds-text-body_regular cc_blink" style="padding:3px 0px 3px 0px">
                        <lightning:icon iconName="utility:success" size="x-small" variant="success" />
                        &nbsp;&nbsp;<p class="slds-form-element__label"><b>Cuenta: {!v.searchAccountName}</b></p>
                    </div>
                </aura:if>
                <aura:if isTrue="{!v.searchContactId != ''}">
                    <div align="left" class="slds-text-body_regular cc_blink" style="padding:3px 0px 3px 0px">
                        <lightning:icon iconName="utility:success" size="x-small" variant="success" />
                        &nbsp;&nbsp;<p class="slds-form-element__label"><b>Contacto: {!v.searchContactName}</b></p>
                    </div>
                </aura:if>
            </div>
            <div style="height:0.4rem;" />
            <!--Separador-->
        </aura:if>

        <!--Resultados-->
        <aura:if isTrue="{!v.bInfo}">
            <!--Sección de información-->
            <div align="center" class="slds-text-body_regular cc_blink" style="padding:3px 0px 3px 0px">
                <lightning:icon iconName="utility:info" size="x-small" variant="success" />
                &nbsp;&nbsp;{!v.sMensInfo}
            </div>
        </aura:if>

        <aura:if isTrue="{!v.bError}">
            <!--Sección de error-->
            <div align="center" class="slds-text-body_regular cc_blink" style="padding:3px 0px 3px 0px">
                <lightning:icon iconName="utility:warning" size="x-small" variant="error" />
                &nbsp;&nbsp;{!v.sMensErr}
            </div>
        </aura:if>

        <!-- Mostrado de resultados -->
        <aura:renderIf isTrue="{!v.mostrarResultados}">
            <div style="{!v.divResultadosStyle}">

                <!--Filtrar resultados-->
                <aura:if isTrue="{!and(v.oContactos != null,v.oContactos.length > 0)}">
                    <div class="slds-card__body slds-card__body_inner" style="position: relative;">
                        <div class="slds-grid slds-gutters slds-grid_pull-padded-small slds-grid_vertical-align-end">
                            <div class="slds-col">
                                <lightning:combobox aura:id="typeSearchContact" name="typeSearchContact" label="Filtrar resultados por" value="{!v.searchTypeContact}" options="{!v.searchOptionsContact}"/>
                            </div>
                            <div class="slds-col">
                                <span onkeypress="{!c.valueSearchKeyContact}">
                                    <lightning:input aura:id="valueSearchContact" type="search" name="valueSearchContact" label="" value="{!v.valueSearch}" onchange="{!c.handleChangeContact}" spellcheck="false" placeholder="Valor a buscar"/>
                                </span>
                            </div>
                            <div class="slds-col slds-grow-none">
                                <lightning:buttonIcon iconName="utility:search" title="Identificar" onclick="{!c.refinarBusquedaContacto}" alternativeText="Refinar la búsqueda de contactos" disabled="{!or(v.valueSearch == '', v.searchTypeContact == '')}" />
                            </div>
                        </div>
                    </div>
                    <div style="height:0.4rem;" />
                    <!--Separador-->
                </aura:if>

                <!--Cuentas-->
                <aura:if isTrue="{!and(v.oCuentas != null,v.oCuentas.length > 0)}">
                    <div class="slds-card__body slds-card__body_inner" style="margin-top: 0;">
                        <div class="slds-form-element">
                            <div class="slds-text-title_caps" style="padding-top: 8px; padding-bottom: 4px;">Cuentas</div>
                            <aura:iteration items="{!v.oCuentas}" var="oCuenta">
                                <article class="slds-card" style="margin-left: 11px; padding-bottom: 3px;">
                                    <div class="slds-card__header slds-grid">
                                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                            <div class="slds-media__figure">
                                                <span class="slds-icon_container slds-icon-standard-account" title="Cuenta">
                                                    <lightning:icon iconName="standard:account" alternativeText="Cuenta" size="small" />
                                                </span>
                                            </div>
                                            <div class="slds-media__body">
                                                <div>
                                                    <h2>
                                                        <a href="javascript:void(0)" class="slds-card__header-link slds-truncate" name="{!oCuenta.idCuenta}" aura:id="{!oCuenta.idCuenta}" title="Visualizar detalle" onclick="{!c.navegarOrigen}">{!oCuenta.nombre}</a>
                                                    </h2>
                                                </div>
                                                
                                            </div>
                                            <div class="slds-no-flex" style="margin-right: 20;">
                                                <lightning:button iconName="utility:check" label="Asociar" name="{!oCuenta.idCuenta}" onclick="{!c.asociarCuenta}" disabled="{!v.estadoCaso == 'Cerrado'}"/>
                                            </div>
                                        </header>
                                    </div>
                                </article>
                            </aura:iteration>
                        </div>
                    </div>
                </aura:if>

                <!--Contactos-->
                <aura:if isTrue="{!and(v.oContactos != null,v.oContactos.length > 0)}">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-form-element">
                            <div class="slds-text-title_caps" style="padding-top: 7px; padding-bottom: 10px;">Contactos</div>
                            <aura:iteration items="{!v.oContactos}" var="oContacto">
                                <article class="slds-card" style="margin-left: 11px; padding-bottom: 3px;">
                                    <div class="slds-card__header slds-grid">
                                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                            <div class="slds-media__figure">
                                                <span class="slds-icon_container slds-icon-standard-account" title="Contacto">
                                                    <lightning:icon iconName="standard:contact" size="small"/>
                                                </span>
                                            </div>
                                            <div class="slds-media__body">
                                                <div>
                                                    <h2>
                                                        <a href="javascript:void(0)" class="slds-card__header-link slds-truncate" name="{!oContacto.idContacto}" aura:id="{!oContacto.idContacto}" title="Visualizar detalle" onclick="{!c.navegarOrigen}">{!oContacto.nombre}</a>
                                                    </h2>
                                                </div>
                                                <div>
                                                    <aura:if isTrue="{! (v.tipoBuscador == 'crearContrato' || v.tipoCaso == 'SEG_Cliente' || v.tipoCaso == 'SEG_Seguimiento')}">
                                                        <p class="slds-form-element__label"><b><i>{!oContacto.nombreCuenta}</i></b> - {!oContacto.cargos}<br />{!oContacto.emailPrincipal}</p>
                                                        <aura:set attribute="else">
                                                            <p class="slds-form-element__label">{!oContacto.nombreCuenta}</p>
                                                        </aura:set>
                                                    </aura:if>
                                                </div>
                                            </div>
                                            <div class="slds-no-flex" style="margin-right: 20;">
                                                <lightning:button iconName="utility:check" label="Asociar" name="{!oContacto.idRelacion}" onclick="{!c.asociarContacto}" disabled="{!v.estadoCaso == 'Cerrado'}"/>
                                            </div>
                                        </header>
                                    </div>
                                </article>
                            </aura:iteration>
                        </div>
                    </div>
                </aura:if>
            </div>

            <div align="center" style="padding-top: 5px; padding-bottom: 10px;">
                <lightning:button iconName="utility:back" label="Anterior" onclick="{!c.beforePage}" disabled="{!v.pagina == 1}" />&nbsp;
                <lightning:button iconName="utility:forward" label="Siguiente" onclick="{!c.nextPage}" disabled="{!v.pagina == v.totalPaginas}" />
            </div>
        </aura:renderIf>
    </article>
</aura:component>