<template>
	<div class="contenedor slds-var-m-around_medium">

		<div class="columnaAcciones slds-var-p-around_medium">

			<!--Botón "Mostrar controles"-->
			<span class="mostrarControles slds-text-color_weak slds-var-m-left_medium" style="cursor: pointer;" onclick={mostrarControlesOnclick}>Mostrar controles</span>

			<!--Controles-->
			<div class="controles slds-hide">
				<div>
					<div class="slds-grid slds-grid_vertical-align-center slds-gutters_direct-xx-small slds-var-m-top_medium">
						<div class="slds-col slds-grow-none">
							<label class="slds-form-element__label labelSeccion">Suscripción</label>
						</div>
						<div class="slds-col" style="width: 160px;">
							<lightning-input class="inputBordeGris" placeholder="Tipo" variant="label-hidden" value={subscriptionType}></lightning-input>
						</div>
						<div class="slds-col" style="width: 160px;">
							<lightning-input class="inputBordeGris" placeholder="Categorías" variant="label-hidden" value={subscriptionCategories}></lightning-input>
						</div>
						<div class="slds-col slds-grow-none">
							<lightning-button-icon class="botonSuscribir buttonIconBordeGris" tooltip="Suscribir" icon-name="utility:broadcast" icon-class={botonesAtributos.suscribirIconClass} variant={botonesAtributos.suscribirVariant} onclick={subscribeToMessageChannel}></lightning-button-icon>
							<lightning-button-icon class="botonDesuscribir buttonIconBordeGris slds-var-m-left_small" tooltip="Desuscribir" icon-name="utility:offline" icon-class={botonesAtributos.desuscribirIconClass} variant={botonesAtributos.desuscribirVariant} onclick={unsubscribeToMessageChannel} disabled></lightning-button-icon>
						</div>
					</div>
				</div>

				<div class="slds-var-m-top_xx-large">
					<label class="slds-form-element__label labelSeccion">Añadir custom attribute a la interacción</label>
					<div class="slds-grid slds-gutters_direct-xx-small">
						<div class="slds-col">
							<lightning-input class="inputAddAtributes inputBordeGris" placeholder="Nuevo custom attribute" variant="label-hidden"></lightning-input>
						</div>
						<div class="slds-col slds-grow-none">
							<lightning-button label="Añadir" class="buttonBordeGris" onclick={buttonAddAttributesOnclick}></lightning-button>
						</div>
					</div>
				</div>

				<div class="slds-var-m-top_xx-large slds-var-p-top_xx-small">
					<div class="slds-grid slds-grid_vertical-align-center slds-gutters_direct-xxx-small">
						<div class="slds-col slds-grow-none">
							<label class="slds-form-element__label labelSeccion">Id de interacción:</label>
						</div>
						<div class="slds-col slds-shrink-none">
							<lightning-input class="inputInteractionId inputBordeGris" value={interactionId} variant="label-hidden" onchange={inputInteractionIdOnchange} disabled spellcheck="false"></lightning-input>
						</div>
						<div class="slds-col slds-grow-none">
							<lightning-button-icon icon-name="utility:edit" size="medium" variant="border-filled" tooltip="Editar" class="buttonIconBordeGris slds-var-m-left_x-small" icon-class="slds-var-p-around_xxx-small" onclick={editarInteractionId}></lightning-button-icon>
							<lightning-button-icon icon-name="utility:light_bulb" size="medium" variant="border-filled" tooltip="Generar id aleatorio" class="buttonIconBordeGris slds-var-m-left_x-small" icon-class="slds-var-p-around_xxx-small" onclick={generarInteractionId}></lightning-button-icon>
							<lightning-button-icon icon-name="utility:copy" size="medium" variant="border-filled" tooltip="Copiar Id de la interacción" class="buttonIconBordeGris botonCopiarIdInteraccion slds-var-m-left_x-small" icon-class="slds-var-p-around_xxx-small" onclick={copiar}></lightning-button-icon>
						</div>
					</div>
				</div>

				<div class="slds-var-m-top_x-large slds-var-p-top_xx-small">
					<label class="slds-form-element__label labelSeccion">Invocar lógica Apex</label>
					<div class="slds-grid slds-gutters_direct-x-small slds-wrap">
						<template for:each={metodosApex} for:item="metodo">
							<div key={metodo.label} class="slds-col slds-size_1-of-2 slds-var-m-bottom_small">
								<div class="slds-button-group grupoBotones" role="group">
									<button class="botonMetodoApex slds-button slds-button_neutral" onclick={botonInvocarMetodoApex} data-nombre={metodo.nombre}>
										<lightning-icon icon-name="utility:apex" size="xx-small" class="botonMetodoApexIcono slds-var-m-right_small"></lightning-icon>
										{metodo.label}
									</button>
									<button
										class="botonMetodoApexAcciones slds-button slds-button_icon slds-button_icon-border-filled"
										aria-haspopup="true" aria-expanded="false" onclick={modalAbrir}
										data-nombre-modal="modalModificarInputApex" data-elemento-focus-class=".modalModificarInputApexCancelar"
										data-metodo-nombre={metodo.nombre}>
											<lightning-icon class="botonMetodoApexInputsIcono" icon-name="utility:picklist_type" size="xx-small"></lightning-icon>
									</button>
								</div>
							</div>
						</template>
					</div>
				</div>
			</div>
		</div>

		<div class="columnaLog slds-var-p-around_medium slds-var-m-top_medium">
			<div class="slds-grid slds-grid_vertical slds-gutters_direct-x-small">
				<!-- Banner -->
				<div class="slds-col slds-var-m-bottom_xx-small">
					<div class={tipoBanner.class} role="status">
						<div class="slds-media__figure">
							<span class="slds-icon_container">
								<lightning-icon icon-name={tipoBanner.iconName} size="x-small" variant="inverse"></lightning-icon>
							</span>
						</div>
						<div class="slds-media__body"><p>{tipoBanner.texto}</p></div>
					</div>
				</div>

				<!-- Historial -->
				<div class="slds-col">
					<div class="slds-grid slds-grid_vertical-align-center slds-var-m-bottom_x-small slds-var-m-left_xx-small">
						<div class="slds-col slds-grow-none">
							<label class="slds-form-element__label labelSeccion slds-is-relative" style="font-size: 12.7px; top: -1px; margin-bottom: 0px;">Historial</label>
						</div>
						<div class="slds-col slds-grow-none">
							<lightning-button-icon tooltip="Copiar todos (solo eventos)" icon-name="utility:copy" size="small" variant="bare" class="slds-var-m-left_small" onclick={copiar}></lightning-button-icon>
							<lightning-button-icon tooltip="Ver solo eventos de categorías relevantes (connect, consultTransfer, blindTransfer, disconnect, ConsultCall, completeConsultTransfer y CompleteConsultCall)" icon-name="utility:filterList" size="small" variant="bare" class="iconoSeleccionable iconoSeleccionado slds-var-m-left_small" onclick={verSoloEventosRelevantes}></lightning-button-icon>
							<lightning-button-icon tooltip="Scroll automático a los nuevos elementos del historial" icon-name="utility:arrow_top" size="small" variant="bare" class="slds-var-m-left_small iconoSeleccionable iconoSeleccionado" onclick={cambiarScrollAutomatico}></lightning-button-icon>
							<lightning-button-icon tooltip="Borrar historial" icon-name="utility:delete" size="small" variant="bare" class="slds-var-m-left_small iconoBorrar" onclick={eliminarLog}></lightning-button-icon>
						</div>
						<div class="controles slds-col slds-var-m-right_x-small slds-hide" align="right">
							<lightning-button-icon tooltip="Simular recepción de evento" icon-name="utility:new" size="small" variant="bare" onclick={modalAbrir} data-nombre-modal="modalSimularRecepcionEvento" data-elemento-focus-class=".modalSimularRecepcionEventoCancelar"></lightning-button-icon>
							<lightning-button-icon tooltip="Simular respuesta API Purecloud" icon-name="utility:http" size="small" variant="bare" class="botonAbrirModalSimularRespuestaApiPurecloud slds-var-m-left_small" onclick={modalAbrir} data-nombre-modal="modalSimularRespuestaApiPurecloud" data-elemento-focus-class=".textareaJsonSimularApiPurecloud"></lightning-button-icon>
							<lightning-button-icon tooltip="Log Desarrollo" icon-name="utility:bug" size="small" variant="bare" class="slds-var-m-left_small" onclick={devLog}></lightning-button-icon>
						</div>
					</div>
					<div class="logDiv">
						<template for:each={logsVisibles} for:item="log">
							<div key={log.key} class="log">
								<span class={log.mensajeCabeceraClass}>
									<div class="slds-grid slds-grid_vertical-align-center slds-gutters_direct-x-small">
										<div class="slds-col">
											<div class="slds-grid slds-gutters_direct-xxx-small slds-var-m-left_medium">
												<div class="slds-col slds-grow-none slds-shrink-none" style="font-size: 11.6px;">
													<lightning-icon icon-name={log.iconName} size="xx-small" class="logMensajeCabeceraIcono slds-var-m-left_xx-small slds-var-m-right_small"></lightning-icon>
													{log.fecha}
												</div>
												<div class="slds-col divLogTipo slds-grow-none slds-text-color_weak slds-var-m-left_xx-small">{log.tipo}</div>
												<div lwc:if={log.apexTriggered} class="slds-col slds-is-relative" style="top: -1px;">
													<div  class="logMensajeDetalle slds-var-p-right_small" align="right">
														<lightning-icon icon-name="utility:forward" size="xx-small" class="logMensajeDetalleIconoFlecha slds-var-m-right_small"></lightning-icon>
														<lightning-icon icon-name="utility:apex" size="xx-small" class="logMensajeDetalleIcono slds-var-m-right_x-small"></lightning-icon>
														<span style="font-weight: 600;">{log.apexTriggered}</span>
													</div>
												</div>
											</div>
										</div>
									</div>
								</span>
								<span class="logMensaje slds-is-relative">
									<pre class={log.class}>
										<div lwc:if={log.tituloText} class="logTitulo">{log.tituloText}</div>
										<div lwc:if={log.text} class="logTexto">{log.text}</div>
									</pre>
									<lightning-button-icon tooltip="Copiar log" class="botonCopiarLog" icon-name="utility:copy" size="small" variant="bare" onclick={copiar} data-evento-key={log.key}></lightning-button-icon>
								</span>
								<hr class="logSeparador"/>
							</div>
						</template>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modales -->
	<template lwc:if={renderizarModales}>
		<section role="dialog" tabindex="-1" aria-modal="true" class="modalModificarInputApex slds-modal slds-modal_small" onkeydown={modalTeclaPulsada}>
			<div class="slds-modal__container modalContainer slds-var-p-top_large slds-var-p-bottom_large">
				<lightning-button-icon icon-name="utility:close" size="large" onclick={cerrarModales} variant="border-filled" class="slds-button slds-button_icon slds-modal__close"></lightning-button-icon>
				<div class="slds-modal__header slds-var-p-bottom_x-small" style="border-style: none;">
					<h1 class="slds-modal__title slds-hyphenate">Modificar parámetros de entrada</h1>
					<p class="slds-var-m-top_x-small">Indica el JSON con los parámetros de entrada para "<span class="negrita">{metodoApexInputEditando}</span>".</p>
				</div>
				<div class="slds-modal__content modalContent slds-var-p-around_x-large">
					<lightning-textarea class="textareaJsonInputApexText" variant="label-hidden" spellcheck="false"></lightning-textarea>
				</div>
				<div class="slds-modal__footer">
					<lightning-button class="modalModificarInputApexCancelar" label="Cancelar" onclick={cerrarModales}></lightning-button>
					<lightning-button class="modalModificarInputApexGuardar slds-var-m-left_medium" label="Guardar" variant="brand" onclick={modalModificarInputApexGuardar}></lightning-button>
				</div>
			</div>
		</section>

		<section role="dialog" tabindex="-1" aria-modal="true" class="modalSimularRecepcionEvento slds-modal slds-modal_medium" onkeydown={modalTeclaPulsada}>
			<div class="slds-modal__container modalContainer slds-var-p-top_large slds-var-p-bottom_large">
				<lightning-button-icon icon-name="utility:close" size="large" onclick={cerrarModales} variant="border-filled" class="slds-button slds-button_icon slds-modal__close"></lightning-button-icon>
				<div class="slds-modal__header">
					<h1 class="slds-modal__title slds-hyphenate">Simular recepción de evento</h1>
					<p class="slds-var-m-top_x-small">Indica el JSON con los datos del evento entrante que quieres simular.</p>
				</div>
				<div class="slds-modal__content modalContent slds-var-p-top_large slds-var-p-right_xx-large slds-var-p-bottom_large slds-var-p-left_xx-large">
					<div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-var-m-bottom_large">
						<div class="slds-col">
							<div class="slds-grid slds-grid_vertical-align-center slds-gutters_direct-xxx-small">
								<div class="slds-col">
									<label class="slds-form-element__label">Plantillas</label>
								</div>
								<div class="slds-col" style="min-width: 232px;">
									<lightning-combobox class="comboboxCambiarPlantilla" options={plantillasModalSimularOpciones} value="registrarLlamadaEntrante" onchange={comboboxPlantillaJsonOnchange} variant="label-hidden"></lightning-combobox>
								</div>
							</div>
						</div>
						<div class="slds-col">
							<div class="slds-grid slds-grid_vertical-align-center">
								<div class="slds-col">
									<label class="slds-form-element__label">Usar Id de la interacción en curso</label>
								</div>
								<div class="slds-col slds-is-relative" style="top: -1px;">
									<lightning-helptext content="El valor del atributo data.id se reemplaza con el id de la interacción en curso si ésta existe."></lightning-helptext>
								</div>
								<div class="slds-col slds-var-m-left_small">
									<lightning-input class="toggleUsarIdActual" type="toggle" checked onchange={toggleUsarIdActualOnchange} message-toggle-active="" message-toggle-inactive="" variant="label-hidden"></lightning-input>
								</div>
							</div>
						</div>
					</div>
					<lightning-textarea class="textareaJsonSimularEvento" variant="label-hidden" spellcheck="false"></lightning-textarea>
				</div>
				<div class="slds-modal__footer">
					<lightning-button class="modalSimularRecepcionEventoCancelar" label="Cancelar" onclick={cerrarModales}></lightning-button>
					<lightning-button class="modalSimularRecepcionEventoPublicar slds-var-m-left_medium" label="Publicar evento" variant="brand" onclick={modalSimularRecepcionEventoPublicar}></lightning-button>
				</div>
			</div>
		</section>

		<section role="dialog" tabindex="-1" aria-modal="true" class="modalSimularRespuestaApiPurecloud slds-modal slds-modal_medium" onkeydown={modalTeclaPulsada}>
			<div class="slds-modal__container modalContainer slds-var-p-top_large slds-var-p-bottom_large">
				<lightning-button-icon icon-name="utility:close" size="large" onclick={cerrarModales} variant="border-filled" class="slds-button slds-button_icon slds-modal__close"></lightning-button-icon>
				<div class="slds-modal__header">
					<h1 class="slds-modal__title slds-hyphenate">Simular respuesta API Purecloud</h1>
					<p class="slds-var-m-top_x-small">Usar una respuesta fija en lugar de invocar a la API de Purecloud</p>
				</div>
				<div class="slds-modal__content modalContent slds-var-p-top_large slds-var-p-right_xx-large slds-var-p-bottom_large slds-var-p-left_xx-large">
					<lightning-textarea class="textareaJsonSimularApiPurecloud" variant="label-hidden" spellcheck="false"></lightning-textarea>
				</div>
				<div class="slds-modal__footer">
					<div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
						<div class="slds-col" style="display: flex;">
							<label class="slds-form-element__label">Simular respuesta API Purecloud</label>
							<lightning-input type="toggle" checked={simularRespuestaApiPurecloud} onchange={toggleSimularRespuestaApiPurecloudOnchange} message-toggle-active="" message-toggle-inactive="" variant="label-hidden"></lightning-input>
						</div>
						<div class="slds-col">
							<lightning-button label="Cerrar" onclick={cerrarModales}></lightning-button>
						</div>
					</div>
				</div>
			</div>
		</section>

		<div class="slds-backdrop modalBackdrop"></div>
	</template>

</template>